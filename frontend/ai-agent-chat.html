<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Chat - VPS DevOps Agent</title>
    <!-- Version: 2.0.0 - Cache Busting -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .message-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .message-ai {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .message-system {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .typing-indicator span {
            animation: bounce 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        .action-badge {
            transition: all 0.3s ease;
        }
        .action-badge:hover {
            transform: scale(1.05);
        }
        #chat-container {
            height: calc(100vh - 200px);
        }
        .conversation-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
    </style>
    <link rel="stylesheet" href="/iframe-styles.css">
</head>
<body class="bg-gray-900 text-white">
    <script src="/iframe-detector.js"></script>
    
    <!-- Main Container -->
    <div class="flex h-screen">
        
        <!-- Sidebar - Conversations List -->
        <aside class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-robot text-purple-500 text-2xl"></i>
                        <span class="text-xl font-bold">AI Agent</span>
                    </div>
                    <button onclick="createNewConversation()" class="bg-purple-600 hover:bg-purple-700 p-2 rounded-lg transition" title="Nouvelle conversation">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <button onclick="location.href='admin.html'" class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm transition">
                    <i class="fas fa-arrow-left mr-2"></i>Retour au Dashboard
                </button>
            </div>
            
            <!-- Conversations List -->
            <div class="flex-1 overflow-y-auto p-4" id="conversations-list">
                <!-- Conversations will be loaded here -->
                <div class="text-center text-gray-400 py-8">
                    <i class="fas fa-comments text-4xl mb-3"></i>
                    <p>Chargement des conversations...</p>
                </div>
            </div>
            
            <!-- User Info -->
            <div class="p-4 border-t border-gray-700">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-user-circle text-2xl text-purple-400"></i>
                    <div class="flex-1">
                        <p class="font-semibold" id="user-username">Chargement...</p>
                        <p class="text-xs text-gray-400">Utilisateur</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col">
            <!-- Chat Header -->
            <header class="bg-gray-800 border-b border-gray-700 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-bold" id="chat-title">S√©lectionnez une conversation</h1>
                        <p class="text-sm text-gray-400" id="chat-subtitle">ou cr√©ez-en une nouvelle</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <!-- Configuration Badge -->
                        <div class="px-3 py-1 bg-purple-900 rounded-full text-xs">
                            <i class="fas fa-brain mr-1"></i>
                            <span id="model-name">GPT-4</span>
                        </div>
                        <!-- Autonomy Level -->
                        <div class="px-3 py-1 bg-blue-900 rounded-full text-xs">
                            <i class="fas fa-shield-alt mr-1"></i>
                            <span id="autonomy-level">Smart</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Messages Container -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- Welcome Message -->
                <div id="welcome-message" class="text-center py-16">
                    <i class="fas fa-robot text-6xl text-purple-500 mb-4"></i>
                    <h2 class="text-2xl font-bold mb-2">Bienvenue dans AI Agent Chat</h2>
                    <p class="text-gray-400 mb-6">Votre assistant DevOps intelligent aliment√© par GPT-4</p>
                    
                    <div class="max-w-2xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <i class="fas fa-code text-blue-400 text-2xl mb-2"></i>
                            <h3 class="font-semibold mb-1">Analyse de Code</h3>
                            <p class="text-sm text-gray-400">Node.js, Python, PHP, Docker</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <i class="fas fa-shield-alt text-green-400 text-2xl mb-2"></i>
                            <h3 class="font-semibold mb-1">S√©curit√©</h3>
                            <p class="text-sm text-gray-400">D√©tection de vuln√©rabilit√©s</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <i class="fas fa-cogs text-purple-400 text-2xl mb-2"></i>
                            <h3 class="font-semibold mb-1">Automatisation</h3>
                            <p class="text-sm text-gray-400">Actions intelligentes</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <i class="fas fa-history text-orange-400 text-2xl mb-2"></i>
                            <h3 class="font-semibold mb-1">Backup & Rollback</h3>
                            <p class="text-sm text-gray-400">Modifications r√©versibles</p>
                        </div>
                    </div>
                </div>
                
                <!-- Messages will be appended here -->
            </div>

            <!-- Input Area -->
            <div class="bg-gray-800 border-t border-gray-700 p-4">
                <form id="chat-form" class="flex items-end space-x-3">
                    <div class="flex-1">
                        <textarea 
                            id="message-input" 
                            rows="1" 
                            class="w-full bg-gray-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
                            placeholder="Posez votre question √† l'AI Agent..."
                            disabled
                        ></textarea>
                    </div>
                    <button 
                        type="submit" 
                        id="send-button"
                        class="bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed px-6 py-3 rounded-lg transition"
                        disabled
                    >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
                <p class="text-xs text-gray-400 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    L'AI Agent peut analyser votre code, proposer des actions et vous assister dans vos t√¢ches DevOps
                </p>
            </div>
        </main>
    </div>

    <!-- Action Confirmation Modal -->
    <div id="action-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 border border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                    Confirmation d'action
                </h3>
                <button onclick="closeActionModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="action-details" class="mb-6">
                <!-- Action details will be inserted here -->
            </div>
            
            <div class="flex space-x-3">
                <button onclick="confirmAction()" class="flex-1 bg-green-600 hover:bg-green-700 py-3 rounded-lg transition">
                    <i class="fas fa-check mr-2"></i>Confirmer
                </button>
                <button onclick="cancelAction()" class="flex-1 bg-red-600 hover:bg-red-700 py-3 rounded-lg transition">
                    <i class="fas fa-times mr-2"></i>Annuler
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // AI Agent Chat - Version 2.0.0
        // Date: 2025-11-23
        // Fix: Cache busting + handleSendMessage
        // ============================================
        console.log('üöÄ AI Agent Chat v2.0.0 loaded');
        
        // Global state
        let currentConversationId = null;
        let currentUser = null;
        let isWaitingResponse = false;
        // Use relative URL to work with Nginx reverse proxy
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001/api' 
            : '/api';
        let authToken = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            authToken = localStorage.getItem('authToken');
            if (!authToken) {
                window.location.href = 'index.html';
                return;
            }

            // Load user info
            await loadUserInfo();
            
            // Load configuration
            await loadConfiguration();
            
            // Load conversations
            await loadConversations();
            
            // Setup form handler
            document.getElementById('chat-form').addEventListener('submit', handleSendMessage);
            
            // Auto-resize textarea
            const textarea = document.getElementById('message-input');
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            });
        });

        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('user-username').textContent = currentUser.username || 'Utilisateur';
                }
            } catch (error) {
                console.error('Erreur chargement utilisateur:', error);
            }
        }

        // Load AI Agent configuration
        async function loadConfiguration() {
            try {
                const response = await fetch(`${API_BASE_URL}/ai/config`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('model-name').textContent = data.config.openai_model.toUpperCase();
                        document.getElementById('autonomy-level').textContent = capitalizeFirst(data.config.autonomy_level);
                    }
                }
            } catch (error) {
                console.error('Erreur chargement configuration:', error);
            }
        }

        // Load conversations
        async function loadConversations() {
            try {
                const response = await fetch(`${API_BASE_URL}/ai/conversations`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Si aucune conversation, en cr√©er une automatiquement
                        if (data.data.length === 0) {
                            console.log('Aucune conversation trouv√©e, cr√©ation automatique...');
                            await createNewConversation();
                            return; // createNewConversation recharge les conversations
                        }
                        
                        displayConversations(data.data);
                        
                        // Auto-s√©lectionner la premi√®re conversation si aucune n'est s√©lectionn√©e
                        if (!currentConversationId && data.data.length > 0) {
                            await selectConversation(data.data[0].id);
                        }
                    }
                } else {
                    throw new Error('Failed to load conversations');
                }
            } catch (error) {
                console.error('Erreur chargement conversations:', error);
                document.getElementById('conversations-list').innerHTML = `
                    <div class="text-center text-red-400 py-8">
                        <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                        <p>Erreur de chargement</p>
                    </div>
                `;
            }
        }

        // Display conversations list
        function displayConversations(conversations) {
            const container = document.getElementById('conversations-list');
            
            if (conversations.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-comments text-4xl mb-3"></i>
                        <p>Aucune conversation</p>
                        <button onclick="createNewConversation()" class="mt-4 bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm transition">
                            Cr√©er une conversation
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = conversations.map(conv => `
                <div class="conversation-item bg-gray-700 rounded-lg p-3 mb-2 cursor-pointer transition hover:bg-gray-600" 
                     data-conversation-id="${conv.id}"
                     onclick="selectConversation(${conv.id})">
                    <div class="flex items-start justify-between mb-2">
                        <h4 class="font-semibold text-sm truncate flex-1">${conv.title || 'Nouvelle conversation'}</h4>
                        <span class="text-xs text-gray-400">${formatDate(conv.last_message_at)}</span>
                    </div>
                    <div class="flex items-center space-x-3 text-xs text-gray-400">
                        <span><i class="fas fa-comment mr-1"></i>${conv.message_count}</span>
                        ${conv.action_count > 0 ? `<span><i class="fas fa-bolt mr-1"></i>${conv.action_count}</span>` : ''}
                        ${conv.server_name ? `<span><i class="fas fa-server mr-1"></i>${conv.server_name}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Create new conversation
        async function createNewConversation() {
            try {
                const response = await fetch(`${API_BASE_URL}/ai/conversations`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        await loadConversations();
                        selectConversation(data.data.id);
                    }
                }
            } catch (error) {
                console.error('Erreur cr√©ation conversation:', error);
                alert('Erreur lors de la cr√©ation de la conversation');
            }
        }

        // Select conversation
        async function selectConversation(conversationId) {
            currentConversationId = conversationId;
            
            // Update UI
            document.getElementById('welcome-message')?.remove();
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-button').disabled = false;
            document.getElementById('chat-title').textContent = 'Conversation #' + conversationId;
            document.getElementById('chat-subtitle').textContent = 'AI Agent DevOps';
            
            // Highlight selected conversation
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('bg-purple-900');
                // Ajouter la classe si c'est la conversation s√©lectionn√©e
                const itemId = item.getAttribute('data-conversation-id');
                if (itemId == conversationId) {
                    item.classList.add('bg-purple-900');
                }
            });
            
            // Load messages
            await loadMessages(conversationId);
        }

        // Load messages for a conversation
        async function loadMessages(conversationId) {
            const container = document.getElementById('chat-container');
            container.innerHTML = '<div class="text-center text-gray-400 py-8"><i class="fas fa-spinner fa-spin text-2xl"></i><p class="mt-2">Chargement des messages...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/ai/conversations/${conversationId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data.messages) {
                        const messages = data.data.messages;
                        
                        // Clear container
                        container.innerHTML = '';
                        
                        if (messages.length === 0) {
                            container.innerHTML = '<div class="text-center text-gray-400 py-8"><i class="fas fa-comments text-4xl mb-3"></i><p>Commencez la conversation !</p></div>';
                        } else {
                            // Display each message
                            messages.forEach(msg => {
                                addMessageToUI(msg.role === 'user' ? 'user' : 'ai', msg.content, msg.actions || []);
                            });
                            
                            // Scroll to bottom
                            container.scrollTop = container.scrollHeight;
                        }
                    } else {
                        container.innerHTML = '<div class="text-center text-red-400 py-8"><i class="fas fa-exclamation-triangle text-4xl mb-3"></i><p>Erreur de chargement</p></div>';
                    }
                } else {
                    throw new Error('Failed to load messages');
                }
            } catch (error) {
                console.error('Erreur chargement messages:', error);
                container.innerHTML = '<div class="text-center text-red-400 py-8"><i class="fas fa-exclamation-triangle text-4xl mb-3"></i><p>Erreur: ' + error.message + '</p></div>';
            }
        }

        // Handle send message
        async function handleSendMessage(e) {
            e.preventDefault();
            
            if (!currentConversationId || isWaitingResponse) {
                return;
            }
            
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) {
                return;
            }
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';
            
            // Add user message to UI
            addMessageToUI('user', message);
            
            // Show typing indicator
            addTypingIndicator();
            
            // Disable input
            isWaitingResponse = true;
            input.disabled = true;
            document.getElementById('send-button').disabled = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/ai/chat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        conversationId: currentConversationId,
                        message: message
                    })
                });
                
                // Remove typing indicator
                removeTypingIndicator();
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data.success) {
                        addMessageToUI('ai', data.data.message, data.data.actions);
                    } else {
                        addMessageToUI('system', 'Erreur: ' + (data.error || 'R√©ponse invalide'));
                    }
                } else {
                    addMessageToUI('system', 'Erreur de communication avec l\'API');
                }
            } catch (error) {
                console.error('Erreur envoi message:', error);
                removeTypingIndicator();
                addMessageToUI('system', 'Erreur: ' + error.message);
            } finally {
                // Re-enable input
                isWaitingResponse = false;
                input.disabled = false;
                document.getElementById('send-button').disabled = false;
                input.focus();
            }
        }

        // Add message to UI
        function addMessageToUI(type, content, actions = []) {
            const container = document.getElementById('chat-container');
            
            // Remove empty state if present
            const emptyState = container.querySelector('.text-center');
            if (emptyState) {
                emptyState.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex ' + (type === 'user' ? 'justify-end' : 'justify-start');
            
            let iconClass = '';
            let messageClass = '';
            
            switch(type) {
                case 'user':
                    iconClass = 'fas fa-user';
                    messageClass = 'message-user';
                    break;
                case 'ai':
                    iconClass = 'fas fa-robot';
                    messageClass = 'message-ai';
                    break;
                case 'system':
                    iconClass = 'fas fa-info-circle';
                    messageClass = 'message-system';
                    break;
            }
            
            let actionsHTML = '';
            if (actions && actions.length > 0) {
                actionsHTML = `
                    <div class="mt-3 space-y-2">
                        <p class="text-xs font-semibold opacity-80">Actions propos√©es:</p>
                        ${actions.map(action => `
                            <div class="action-badge bg-white bg-opacity-20 rounded px-3 py-2 text-sm">
                                <i class="fas fa-bolt mr-2"></i>${action.description || action.type}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="max-w-2xl ${messageClass} text-white rounded-lg p-4 shadow-lg">
                    <div class="flex items-start space-x-2 mb-2">
                        <i class="${iconClass}"></i>
                        <span class="text-xs opacity-80 font-semibold">${type === 'user' ? 'Vous' : type === 'ai' ? 'AI Agent' : 'Syst√®me'}</span>
                    </div>
                    <div class="text-sm leading-relaxed whitespace-pre-wrap">${escapeHtml(content)}</div>
                    ${actionsHTML}
                    <div class="text-xs opacity-60 mt-2">${new Date().toLocaleTimeString('fr-FR')}</div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Add typing indicator
        function addTypingIndicator() {
            const container = document.getElementById('chat-container');
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'flex justify-start';
            indicator.innerHTML = `
                <div class="bg-gray-700 text-white rounded-lg p-4 shadow-lg">
                    <div class="typing-indicator flex space-x-1">
                        <span class="w-2 h-2 bg-white rounded-full"></span>
                        <span class="w-2 h-2 bg-white rounded-full"></span>
                        <span class="w-2 h-2 bg-white rounded-full"></span>
                    </div>
                </div>
            `;
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return '√Ä l\'instant';
            if (minutes < 60) return `${minutes}min`;
            if (hours < 24) return `${hours}h`;
            if (days < 7) return `${days}j`;
            return date.toLocaleDateString('fr-FR');
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Action modal functions
        function closeActionModal() {
            document.getElementById('action-modal').classList.add('hidden');
        }

        function confirmAction() {
            // TODO: Implement action confirmation
            closeActionModal();
        }

        function cancelAction() {
            closeActionModal();
        }
    </script>
</body>
</html>
