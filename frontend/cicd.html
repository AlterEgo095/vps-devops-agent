<!DOCTYPE html>
<html lang="fr">
<head>
    <script src="/auth-guard.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CI/CD Pipeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-tab { cursor: pointer; transition: all 0.3s; }
        .nav-tab.active { background: #3b82f6; color: white; }
    </style>
    <link rel="stylesheet" href="/iframe-styles.css">
</head>
<body class="bg-gray-100">
    <script src="/iframe-detector.js"></script>
    <div class="container mx-auto p-6">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fas fa-rocket mr-3 text-blue-500"></i>CI/CD Pipeline
            </h1>
        </div>
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex border-b">
                <div class="nav-tab active px-6 py-3" onclick="switchTab('projects')">
                    <i class="fas fa-folder mr-2"></i>Projets
                </div>
                <div class="nav-tab px-6 py-3" onclick="switchTab('deployments')">
                    <i class="fas fa-rocket mr-2"></i>DÃ©ploiements
                </div>
            </div>
        </div>
        <div id="projects-tab" class="tab-content active">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">Projets CI/CD</h2>
                <div id="projects-list"></div>
            </div>
        </div>
        <div id="deployments-tab" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">DÃ©ploiements</h2>
                <div id="deployments-list"></div>
            </div>
        </div>
    </div>
    <script>
        // ðŸ” Protection: Require authentication
        AuthGuard.protectPage({
            requireAuth: true,
            onSuccess: () => console.log("âœ… Page access granted"),
            onFail: () => console.log("â›” Access denied - redirecting...")
        });
        
        // Create API interceptor
        const apiCall = AuthGuard.createApiInterceptor();

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
            event.target.closest('.nav-tab').classList.add('active');
        }
        async function loadProjects() {
            const res = await fetch('/api/cicd/projects');
            const data = await res.json();
            const list = document.getElementById('projects-list');
            list.innerHTML = data.projects.map(p => `
                <div class="border p-4 rounded mb-2">
                    <h3 class="font-bold">${p.name}</h3>
                    <p class="text-sm text-gray-600">${p.repo_url}</p>
                </div>
            `).join('');
        }
        loadProjects();
    </script>
</body>
</html>
