#!/usr/bin/env python3

"""
üîç SCANNER DE VULN√âRABILIT√âS - VPS DEVOPS AGENT
Version: 1.0
Date: 2025-11-24
Description: Scanner automatis√© pour d√©tecter vuln√©rabilit√©s critiques dans le code
"""

import os
import re
import json
import sqlite3
from pathlib import Path
from datetime import datetime
from typing import List, Dict, Tuple

# Configuration
PROJECT_DIR = "/opt/vps-devops-agent"
BACKEND_DIR = f"{PROJECT_DIR}/backend"
FRONTEND_DIR = f"{PROJECT_DIR}/frontend"
DB_PATH = f"{PROJECT_DIR}/data/devops-agent.db"
REPORT_FILE = f"{PROJECT_DIR}/VULNERABILITY_SCAN_{datetime.now().strftime('%Y%m%d-%H%M%S')}.json"

# Compteurs globaux
vulnerabilities = {
    "critical": [],
    "high": [],
    "medium": [],
    "low": [],
    "info": []
}

################################################################################
# PATTERNS DE VULN√âRABILIT√âS
################################################################################

VULNERABILITY_PATTERNS = {
    "sql_injection": [
        (r'(SELECT|INSERT|UPDATE|DELETE).*\+\s*[\w\[\]\'"]', "Concat√©nation SQL dangereuse"),
        (r'\.exec\(["\']SELECT.*\$\{', "Template literal SQL sans pr√©paration"),
        (r'\.run\(["\']SELECT.*\$\{', "Template literal SQL sans pr√©paration"),
    ],
    
    "xss": [
        (r'innerHTML\s*=\s*[^"\']', "innerHTML avec donn√©es non sanitiz√©es"),
        (r'document\.write\(', "document.write() utilis√©"),
        (r'eval\(', "eval() utilis√© - code injection possible"),
        (r'\.html\(.*req\.', "jQuery .html() avec donn√©es request"),
    ],
    
    "command_injection": [
        (r'exec\(.*\+', "Ex√©cution commande avec concat√©nation"),
        (r'spawn\(.*\$\{', "spawn() avec template literal"),
        (r'child_process.*shell.*true', "child_process avec shell=true"),
    ],
    
    "path_traversal": [
        (r'\.\./', "Path traversal pattern d√©tect√©"),
        (r'readFile\(.*req\.(body|params|query)', "readFile avec input utilisateur"),
        (r'writeFile\(.*req\.(body|params|query)', "writeFile avec input utilisateur"),
    ],
    
    "weak_crypto": [
        (r'crypto\.createCipher\(', "crypto.createCipher obsol√®te (utiliser createCipheriv)"),
        (r'md5|sha1', "Hash MD5/SHA1 faible"),
        (r'Math\.random\(\)', "Math.random() pour crypto (utiliser crypto.randomBytes)"),
    ],
    
    "hardcoded_secrets": [
        (r'password\s*=\s*["\'][^"\']{8,}["\']', "Mot de passe en dur"),
        (r'api[_-]?key\s*=\s*["\'][^"\']+["\']', "API Key en dur"),
        (r'secret\s*=\s*["\'][^"\']{16,}["\']', "Secret en dur"),
        (r'token\s*=\s*["\'][^"\']{20,}["\']', "Token en dur"),
    ],
    
    "authentication": [
        (r'expiresIn.*["\'](\d+)d["\']', "Token expiration longue"),
        (r'algorithm.*none', "JWT algorithm 'none'"),
        (r'bcrypt\.hash.*[,\s]+(\d+)', "bcrypt cost factor"),
    ],
    
    "cors": [
        (r'origin.*["\']?\*["\']?', "CORS wildcard"),
        (r'credentials.*true', "CORS credentials enabled"),
    ],
    
    "info_disclosure": [
        (r'console\.log\(.*password', "Password logg√© en console"),
        (r'console\.log\(.*token', "Token logg√© en console"),
        (r'app\.use.*express\.static', "Static files expos√©s"),
    ]
}

################################################################################
# FONCTIONS DE SCAN
################################################################################

def add_vulnerability(severity: str, title: str, description: str, file_path: str, 
                     line_number: int, code_snippet: str, remediation: str):
    """Ajouter une vuln√©rabilit√© d√©tect√©e"""
    vuln = {
        "title": title,
        "description": description,
        "severity": severity,
        "file": file_path,
        "line": line_number,
        "code": code_snippet.strip(),
        "remediation": remediation,
        "timestamp": datetime.now().isoformat()
    }
    vulnerabilities[severity].append(vuln)

def scan_file_patterns(file_path: str):
    """Scanner un fichier pour patterns de vuln√©rabilit√©s"""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
            lines = content.split('\n')
            
            for line_num, line in enumerate(lines, 1):
                # SQL Injection
                for pattern, description in VULNERABILITY_PATTERNS["sql_injection"]:
                    if re.search(pattern, line, re.IGNORECASE):
                        add_vulnerability(
                            "critical",
                            "SQL Injection Potentielle",
                            description,
                            file_path,
                            line_num,
                            line,
                            "Utiliser db.prepare() avec param√®tres bind√©s"
                        )
                
                # XSS
                for pattern, description in VULNERABILITY_PATTERNS["xss"]:
                    if re.search(pattern, line, re.IGNORECASE):
                        add_vulnerability(
                            "high",
                            "Cross-Site Scripting (XSS)",
                            description,
                            file_path,
                            line_num,
                            line,
                            "Utiliser DOMPurify.sanitize() ou textContent"
                        )
                
                # Command Injection
                for pattern, description in VULNERABILITY_PATTERNS["command_injection"]:
                    if re.search(pattern, line, re.IGNORECASE):
                        add_vulnerability(
                            "critical",
                            "Command Injection",
                            description,
                            file_path,
                            line_num,
                            line,
                            "Valider input et √©viter shell=true"
                        )
                
                # Path Traversal
                for pattern, description in VULNERABILITY_PATTERNS["path_traversal"]:
                    if re.search(pattern, line, re.IGNORECASE):
                        add_vulnerability(
                            "high",
                            "Path Traversal",
                            description,
                            file_path,
                            line_num,
                            line,
                            "Valider chemins avec path.normalize() et v√©rifier boundary"
                        )
                
                # Weak Crypto
                for pattern, description in VULNERABILITY_PATTERNS["weak_crypto"]:
                    if re.search(pattern, line, re.IGNORECASE):
                        add_vulnerability(
                            "medium",
                            "Cryptographie Faible",
                            description,
                            file_path,
                            line_num,
                            line,
                            "Utiliser algorithmes modernes (AES-256-GCM, SHA-256+)"
                        )
                
                # Hardcoded Secrets
                for pattern, description in VULNERABILITY_PATTERNS["hardcoded_secrets"]:
                    if re.search(pattern, line, re.IGNORECASE):
                        # Ignorer commentaires et exemples
                        if not line.strip().startswith('//') and 'example' not in line.lower():
                            add_vulnerability(
                                "critical",
                                "Secret en Dur",
                                description,
                                file_path,
                                line_num,
                                line[:50] + "...",  # Tronquer pour s√©curit√©
                                "D√©placer secrets vers .env"
                            )
                
                # CORS
                for pattern, description in VULNERABILITY_PATTERNS["cors"]:
                    if re.search(pattern, line, re.IGNORECASE):
                        severity = "critical" if "*" in line else "medium"
                        add_vulnerability(
                            severity,
                            "Configuration CORS Permissive",
                            description,
                            file_path,
                            line_num,
                            line,
                            "Whitelist domaines sp√©cifiques"
                        )
    
    except Exception as e:
        print(f"Erreur scan {file_path}: {e}")

def scan_jwt_configuration():
    """Scanner configuration JWT"""
    auth_file = f"{BACKEND_DIR}/middleware/auth.js"
    if not os.path.exists(auth_file):
        add_vulnerability(
            "high",
            "Fichier Auth Manquant",
            "middleware/auth.js non trouv√©",
            auth_file,
            0,
            "",
            "Cr√©er middleware d'authentification"
        )
        return
    
    with open(auth_file, 'r') as f:
        content = f.read()
        
        # V√©rifier expiration
        exp_match = re.search(r'expiresIn.*["\'](\d+)([dwh])["\']', content)
        if exp_match:
            value, unit = exp_match.groups()
            value = int(value)
            
            if unit == 'd' and value > 30:
                add_vulnerability(
                    "medium",
                    "Token Expiration Trop Longue",
                    f"Token expire dans {value} jours",
                    auth_file,
                    0,
                    exp_match.group(0),
                    "R√©duire √† 7 jours max + refresh tokens"
                )
        
        # V√©rifier algorithme
        if re.search(r'algorithm.*["\']none["\']', content, re.IGNORECASE):
            add_vulnerability(
                "critical",
                "JWT Algorithm 'none'",
                "Algorithme JWT d√©sactiv√© - vuln√©rabilit√© majeure",
                auth_file,
                0,
                "",
                "Utiliser HS256 ou RS256"
            )

def scan_database_security():
    """Scanner s√©curit√© base de donn√©es"""
    if not os.path.exists(DB_PATH):
        add_vulnerability(
            "high",
            "Base de Donn√©es Non Trouv√©e",
            f"DB non trouv√©e: {DB_PATH}",
            DB_PATH,
            0,
            "",
            "V√©rifier chemin DB"
        )
        return
    
    # V√©rifier permissions
    stat_info = os.stat(DB_PATH)
    perms = oct(stat_info.st_mode)[-3:]
    
    if perms not in ['600', '640']:
        add_vulnerability(
            "medium",
            "Permissions DB Trop Permissives",
            f"Permissions actuelles: {perms}",
            DB_PATH,
            0,
            f"chmod {perms} {DB_PATH}",
            f"chmod 600 {DB_PATH}"
        )
    
    # V√©rifier tables de s√©curit√©
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        
        # V√©rifier tables existantes
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
        tables = [row[0] for row in cursor.fetchall()]
        
        security_tables = {
            "audit_logs": "Table d'audit pour tra√ßabilit√©",
            "token_blacklist": "R√©vocation de tokens JWT",
            "two_factor_attempts": "Logs tentatives 2FA"
        }
        
        for table, description in security_tables.items():
            if table not in tables:
                add_vulnerability(
                    "high" if table == "audit_logs" else "medium",
                    f"Table {table} Manquante",
                    description,
                    DB_PATH,
                    0,
                    "",
                    f"CREATE TABLE {table} (...)"
                )
        
        # V√©rifier mots de passe en clair
        if "users" in tables:
            cursor.execute("SELECT password FROM users LIMIT 1")
            pwd = cursor.fetchone()
            if pwd and not (pwd[0].startswith('$2') or pwd[0].startswith('$argon2')):
                add_vulnerability(
                    "critical",
                    "Mots de Passe Non Hash√©s",
                    "Mots de passe en clair ou hash faible dans DB",
                    DB_PATH,
                    0,
                    "",
                    "Hasher avec bcrypt ou argon2"
                )
        
        conn.close()
    except Exception as e:
        print(f"Erreur scan DB: {e}")

def scan_package_json():
    """Scanner package.json pour d√©pendances vuln√©rables"""
    pkg_file = f"{BACKEND_DIR}/package.json"
    if not os.path.exists(pkg_file):
        return
    
    with open(pkg_file, 'r') as f:
        pkg = json.load(f)
    
    # V√©rifier d√©pendances de s√©curit√© manquantes
    recommended_deps = {
        "helmet": "Headers de s√©curit√©",
        "express-rate-limit": "Rate limiting",
        "joi": "Validation des entr√©es",
        "argon2": "Hashing s√©curis√©"
    }
    
    all_deps = {**pkg.get('dependencies', {}), **pkg.get('devDependencies', {})}
    
    for dep, description in recommended_deps.items():
        if dep not in all_deps:
            add_vulnerability(
                "medium",
                f"D√©pendance Manquante: {dep}",
                description,
                pkg_file,
                0,
                "",
                f"npm install {dep}"
            )

def scan_env_configuration():
    """Scanner fichier .env"""
    env_file = f"{BACKEND_DIR}/.env"
    
    if not os.path.exists(env_file):
        add_vulnerability(
            "high",
            "Fichier .env Manquant",
            "Secrets possiblement en dur dans le code",
            env_file,
            0,
            "",
            "Cr√©er .env et d√©placer secrets"
        )
        return
    
    # V√©rifier permissions
    stat_info = os.stat(env_file)
    perms = oct(stat_info.st_mode)[-3:]
    
    if perms != '600':
        add_vulnerability(
            "high",
            "Permissions .env Incorrectes",
            f"Permissions: {perms} (devrait √™tre 600)",
            env_file,
            0,
            "",
            f"chmod 600 {env_file}"
        )
    
    # V√©rifier contenu
    with open(env_file, 'r') as f:
        content = f.read()
        
        if 'JWT_SECRET' in content:
            match = re.search(r'JWT_SECRET\s*=\s*["\']?([^"\'\n]+)["\']?', content)
            if match:
                secret = match.group(1)
                if len(secret) < 32:
                    add_vulnerability(
                        "critical",
                        "JWT_SECRET Trop Court",
                        f"Longueur: {len(secret)} caract√®res (min 32)",
                        env_file,
                        0,
                        "JWT_SECRET=***",
                        "G√©n√©rer secret 64+ caract√®res"
                    )

def scan_frontend_security():
    """Scanner s√©curit√© frontend"""
    auth_guard = f"{FRONTEND_DIR}/auth-guard.js"
    
    if not os.path.exists(auth_guard):
        add_vulnerability(
            "high",
            "AuthGuard Manquant",
            "Pas de protection frontend",
            auth_guard,
            0,
            "",
            "Cr√©er auth-guard.js"
        )
        return
    
    with open(auth_guard, 'r') as f:
        content = f.read()
        
        # V√©rifier debug mode
        if re.search(r'debugMode\s*:\s*true', content):
            add_vulnerability(
                "medium",
                "Debug Mode Activ√©",
                "debugMode: true en production",
                auth_guard,
                0,
                "debugMode: true",
                "debugMode: false"
            )
        
        # V√©rifier localStorage
        if 'localStorage' in content:
            add_vulnerability(
                "medium",
                "Token en localStorage",
                "Vuln√©rable aux attaques XSS",
                auth_guard,
                0,
                "localStorage.setItem",
                "Utiliser httpOnly cookies si possible"
            )

################################################################################
# SCAN PRINCIPAL
################################################################################

def scan_directory(directory: str, extensions: List[str]):
    """Scanner r√©cursivement un r√©pertoire"""
    for root, dirs, files in os.walk(directory):
        # Ignorer node_modules et .git
        dirs[:] = [d for d in dirs if d not in ['node_modules', '.git', 'dist', 'build']]
        
        for file in files:
            if any(file.endswith(ext) for ext in extensions):
                file_path = os.path.join(root, file)
                scan_file_patterns(file_path)

def generate_report():
    """G√©n√©rer rapport JSON"""
    total = sum(len(v) for v in vulnerabilities.values())
    score = max(0, 100 - (
        len(vulnerabilities["critical"]) * 20 +
        len(vulnerabilities["high"]) * 10 +
        len(vulnerabilities["medium"]) * 5 +
        len(vulnerabilities["low"]) * 2
    ))
    
    report = {
        "scan_date": datetime.now().isoformat(),
        "project": PROJECT_DIR,
        "summary": {
            "total_vulnerabilities": total,
            "critical": len(vulnerabilities["critical"]),
            "high": len(vulnerabilities["high"]),
            "medium": len(vulnerabilities["medium"]),
            "low": len(vulnerabilities["low"]),
            "info": len(vulnerabilities["info"]),
            "security_score": score
        },
        "vulnerabilities": vulnerabilities,
        "recommendations": generate_recommendations()
    }
    
    with open(REPORT_FILE, 'w') as f:
        json.dump(report, f, indent=2)
    
    return report

def generate_recommendations():
    """G√©n√©rer recommandations bas√©es sur vuln√©rabilit√©s"""
    recs = []
    
    if len(vulnerabilities["critical"]) > 0:
        recs.append({
            "priority": "URGENT",
            "title": "Corriger vuln√©rabilit√©s CRITIQUES",
            "description": f"{len(vulnerabilities['critical'])} vuln√©rabilit√©s critiques d√©tect√©es",
            "actions": [
                "Arr√™ter d√©ploiements jusqu'√† correction",
                "Patcher imm√©diatement",
                "Audit manuel compl√©mentaire"
            ]
        })
    
    # Recommandations sp√©cifiques
    vuln_types = {}
    for severity in vulnerabilities:
        for vuln in vulnerabilities[severity]:
            vuln_types[vuln['title']] = vuln_types.get(vuln['title'], 0) + 1
    
    if vuln_types.get("SQL Injection Potentielle", 0) > 0:
        recs.append({
            "priority": "HIGH",
            "title": "S√©curiser requ√™tes SQL",
            "description": f"{vuln_types['SQL Injection Potentielle']} instances d√©tect√©es",
            "actions": [
                "Utiliser db.prepare() partout",
                "Valider toutes les entr√©es avec Joi",
                "Tester avec SQLMap"
            ]
        })
    
    return recs

def print_summary(report: Dict):
    """Afficher r√©sum√© dans la console"""
    print("\n" + "="*70)
    print("   üîç R√âSUM√â DU SCAN DE VULN√âRABILIT√âS")
    print("="*70 + "\n")
    
    summary = report["summary"]
    print(f"üìä Vuln√©rabilit√©s d√©tect√©es: {summary['total_vulnerabilities']}")
    print(f"   üî¥ Critiques: {summary['critical']}")
    print(f"   üü† Hautes:    {summary['high']}")
    print(f"   üü° Moyennes:  {summary['medium']}")
    print(f"   üîµ Basses:    {summary['low']}")
    print(f"\nüéØ Score de s√©curit√©: {summary['security_score']}/100")
    
    if summary['security_score'] >= 80:
        print("   ‚úÖ Niveau: EXCELLENT")
    elif summary['security_score'] >= 60:
        print("   üü° Niveau: BON")
    elif summary['security_score'] >= 40:
        print("   üü† Niveau: MOYEN")
    else:
        print("   üî¥ Niveau: FAIBLE")
    
    print(f"\nüìÑ Rapport d√©taill√©: {REPORT_FILE}")
    print("="*70 + "\n")

################################################################################
# MAIN
################################################################################

def main():
    print("üîç Scanner de Vuln√©rabilit√©s - VPS DevOps Agent")
    print("=" * 70)
    
    if not os.path.exists(PROJECT_DIR):
        print(f"‚ùå ERREUR: Projet non trouv√©: {PROJECT_DIR}")
        print("Modifiez PROJECT_DIR au d√©but du script.")
        return
    
    print(f"üìÇ Scan du projet: {PROJECT_DIR}\n")
    
    # Scans sp√©cifiques
    print("üîç Scan configuration JWT...")
    scan_jwt_configuration()
    
    print("üîç Scan s√©curit√© base de donn√©es...")
    scan_database_security()
    
    print("üîç Scan package.json...")
    scan_package_json()
    
    print("üîç Scan fichier .env...")
    scan_env_configuration()
    
    print("üîç Scan frontend...")
    scan_frontend_security()
    
    # Scan fichiers backend
    print("üîç Scan fichiers backend...")
    if os.path.exists(BACKEND_DIR):
        scan_directory(BACKEND_DIR, ['.js', '.ts'])
    
    # Scan fichiers frontend
    print("üîç Scan fichiers frontend...")
    if os.path.exists(FRONTEND_DIR):
        scan_directory(FRONTEND_DIR, ['.js', '.ts', '.html'])
    
    # G√©n√©rer rapport
    print("\nüìä G√©n√©ration du rapport...")
    report = generate_report()
    
    # Afficher r√©sum√©
    print_summary(report)
    
    # Code de sortie
    if report["summary"]["critical"] > 0:
        return 2
    elif report["summary"]["high"] > 0:
        return 1
    return 0

if __name__ == "__main__":
    exit(main())
