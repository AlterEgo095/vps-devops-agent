import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import { createServer } from 'http';
import { verifyToken } from './middleware/auth.js';
import agentRouter from './routes/agent.js';
import capabilitiesRouter from './routes/capabilities.js';
import authRouter from './routes/auth-v2.js';
import adminRouter from './routes/admin.js';
import subscriptionV2Router from './routes/subscription-v2.js';
import projectsRouter from './routes/projects.js';
import usersRouter from './routes/v2/users.js';
import sessionsRouter from './routes/v2/sessions.js';
import auditRouter from './routes/v2/audit.js';
import monitoringRouter from './routes/monitoring.js';
import aiAgentRouter from './routes/ai-agent.js';
import { capabilitiesRateLimiter, getRateLimitStats, resetRateLimit } from './middleware/rateLimiter.js';
import { metricsMiddleware, errorMetricsMiddleware } from './middleware/metrics.js';
import setupWebSocketServer from './services/websocketServer.js';
import logManager from './services/logManager.js';

// Import Swagger (with error handling)
let swaggerJsdoc, swaggerUi, swaggerOptions;
try {
  const swaggerJsdocModule = await import('swagger-jsdoc');
  swaggerJsdoc = swaggerJsdocModule.default;
  
  const swaggerUiModule = await import('swagger-ui-express');
  swaggerUi = swaggerUiModule.default;
  
  const swaggerConfigModule = await import('./config/swagger.js');
  swaggerOptions = swaggerConfigModule.swaggerOptions;
  
  console.log('✅ Swagger modules loaded successfully');
} catch (error) {
  console.warn('⚠️ Swagger modules not available:', error.message);
  swaggerJsdoc = null;
  swaggerUi = null;
}

const app = express();
const PORT = process.env.PORT || 3001;

// Middleware de sécurité
app.use(helmet({
  contentSecurityPolicy: false, // Désactiver pour Swagger UI
}));
app.use(cors());
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Metrics middleware (records all requests)
app.use(metricsMiddleware);

// Logging middleware with logManager
app.use((req, res, next) => {
  console.log(`[${new Date().toISOString()}] ${req.method} ${req.path}`);
  logManager.info(`${req.method} ${req.path}`, { 
    ip: req.ip,
    userAgent: req.get('user-agent')
  });
  next();
});

// Documentation Swagger (si disponible)
if (swaggerJsdoc && swaggerUi && swaggerOptions) {
  try {
    const swaggerSpec = swaggerJsdoc(swaggerOptions);
    app.use('/api/docs', swaggerUi.serve, swaggerUi.setup(swaggerSpec, {
      customSiteTitle: 'VPS DevOps Agent API',
      customfavIcon: '/favicon.ico',
      customCss: '.swagger-ui .topbar { display: none }'
    }));
    app.get('/api/docs.json', (req, res) => {
      res.setHeader('Content-Type', 'application/json');
      res.send(swaggerSpec);
    });
    console.log('✅ Swagger UI enabled at /api/docs');
  } catch (error) {
    console.error('❌ Error setting up Swagger:', error.message);
  }
}

// Health check endpoint (public - no auth)
app.get('/api/health', (req, res) => {
  res.json({
    status: 'online',
    version: '2.1.0',
    timestamp: new Date().toISOString(),
    sprint: 'Sprint 2 + Phase 1 - Multi-User RBAC Complete',
    features: {
      sprint1: [
        'readMultipleFiles - Lecture batch avec glob patterns',
        'searchInFiles - Recherche grep-like avec contexte',
        'analyzeCodebase - Analyse complète de projet',
        'editFile - Édition multi-zone avec backup/rollback'
      ],
      sprint2: [
        'REST API endpoints for all capabilities',
        'Swagger/OpenAPI 3.0 documentation',
        'Rate limiting per endpoint',
        'JWT authentication',
        'Input validation and error handling'
      ],
      phase1: [
        'Multi-user system with RBAC',
        'User management (CRUD operations)',
        'Session management with revocation',
        'Audit logging with filtering',
        'Role-based permissions (admin, user, readonly)'
      ]
    },
    endpoints: {
      documentation: '/api/docs',
      auth: '/api/auth/*',
      admin: '/api/admin/*',
      subscription: '/api/subscription/*',
      projects: '/api/projects/*',
      capabilities: '/api/capabilities/*',
      agent: '/api/agent/*',
      rateLimits: '/api/rate-limit/stats',
      users: '/api/v2/users',
      sessions: '/api/v2/sessions',
      audit: '/api/v2/audit',
      monitoring: '/api/monitoring/*',
      metricsPrometheus: '/metrics'
    }
  });
});

// Rate limit stats endpoint (requires auth)
app.get('/api/rate-limit/stats', verifyToken, (req, res) => {
  const stats = getRateLimitStats();
  res.json({
    success: true,
    stats
  });
});

// Rate limit reset endpoint (requires auth)
app.post('/api/rate-limit/reset', verifyToken, (req, res) => {
  const { identifier } = req.body;
  if (!identifier) {
    return res.status(400).json({
      success: false,
      error: 'identifier is required'
    });
  }
  
  const result = resetRateLimit(identifier);
  res.json(result);
});

// Serve static files from frontend directory
app.use(express.static('frontend'));

// Serve index.html at root
app.get('/', (req, res) => {
  res.sendFile('index.html', { root: 'frontend' });
});

// Authentication routes (public)
app.use('/api/auth', authRouter);

// Routes principales avec authentification et rate limiting
app.use('/api/agent', verifyToken, agentRouter);
app.use('/api/capabilities', verifyToken, capabilitiesRouter); // Rate limiters applied per-route

// Admin routes - Subscription & payment management
app.use('/api/admin', adminRouter);

// Subscription routes v2
app.use('/api/subscription', subscriptionV2Router);

// Projects routes
app.use('/api/projects', verifyToken, projectsRouter);

// Routes v2 - Multi-user RBAC system
app.use('/api/v2/users', verifyToken, usersRouter);
app.use('/api/v2/sessions', verifyToken, sessionsRouter);
app.use('/api/v2/audit', verifyToken, auditRouter);

// Monitoring routes - Phase 3
app.use('/api/monitoring', verifyToken, monitoringRouter);

app.use('/api/ai', verifyToken, aiAgentRouter); // AI Agent routes - Phase 5

// Prometheus metrics endpoint (public for scraping)
app.get('/metrics', monitoringRouter);

// Error metrics middleware
app.use(errorMetricsMiddleware);

// 404 handler
app.use((req, res) => {
  res.status(404).json({
    success: false,
    error: 'Endpoint not found',
    path: req.path,
    method: req.method,
    availableEndpoints: [
      'GET /api/health',
      'GET /api/docs',
      'POST /api/auth/login',
      'POST /api/agent/quick-execute',
      'POST /api/capabilities/read-multiple',
      'POST /api/capabilities/search',
      'POST /api/capabilities/analyze',
      'POST /api/capabilities/edit',
      'GET /api/capabilities/list',
      'GET /api/admin/dashboard',
      'GET /api/admin/users',
      'GET /api/subscription/*',
      'GET /api/projects/*',
      'GET /api/v2/users',
      'GET /api/v2/sessions',
      'GET /api/v2/audit'
    ]
  });
});

// Error handler
app.use((err, req, res, next) => {
  console.error('Error:', err);
  res.status(err.status || 500).json({
    success: false,
    error: err.message || 'Internal server error',
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  });
});

// Démarrage du serveur avec WebSocket support
const httpServer = createServer(app);

// Setup WebSocket server
setupWebSocketServer(httpServer);

httpServer.listen(PORT, '0.0.0.0', () => {
  const banner = `
╔════════════════════════════════════════════════════════════════╗
║                  VPS DevOps Agent API Server                   ║
║                        Version 2.0.0                           ║
║              Sprint 2 + Option A + Phase 1 Complete            ║
╠════════════════════════════════════════════════════════════════╣
║  Server running on: http://0.0.0.0:${PORT}                         ║
║  Documentation: http://localhost:${PORT}/api/docs                  ║
║  Health check: http://localhost:${PORT}/api/health                 ║
║  WebSocket: ws://localhost:${PORT}/ws/logs                         ║
╠════════════════════════════════════════════════════════════════╣
║  Features:                                                     ║
║  ✅ 17 capabilities (13 basic + 4 Sprint 1)                    ║
║  ✅ REST API endpoints                                         ║
║  ✅ Swagger/OpenAPI 3.0 documentation                          ║
║  ✅ Rate limiting                                              ║
║  ✅ JWT authentication                                         ║
║  ✅ Real-time logs via WebSocket                               ║
║  ✅ Multi-user RBAC system (Phase 1)                           ║
║  ✅ Audit logging & session management                         ║
╚════════════════════════════════════════════════════════════════╝
  `;
  console.log(banner);
  logManager.success('Server started successfully', { port: PORT });
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('SIGTERM received, shutting down gracefully...');
  logManager.warning('Server shutting down (SIGTERM)');
  process.exit(0);
});

process.on('SIGINT', () => {
  console.log('SIGINT received, shutting down gracefully...');
  logManager.warning('Server shutting down (SIGINT)');
  process.exit(0);
});
